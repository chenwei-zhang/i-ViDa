<!--https://stackoverflow.com/a/39731911/1177832-->
<!DOCTYPE html>
<html>

<head>
  <style>
    .flowline {
      fill: none;
      stroke: red;
      opacity: 1;
      stroke-width: 4;
    }
    .traceline {
      fill: none;
      stroke: grey;
      stroke-width: 4;
    }
  </style>
</head>

<body>
  <script src="js/d3.v6.min.js"></script>
  <script>
    var width = 960,
      height = 500;

    var svg = d3.select('body').append('svg')
      .attr('width', width)
      .attr('height', height);
    var trace =[
      {x1: 100, y1: 100, x2: 300, y2: 100, t: 0.4, d: 0},
      {x1: 300, y1: 100, x2: 200, y2: 300, t: 0.8, d: 0.4},
      {x1: 200, y1: 300, x2: 300, y2: 250, t: 0.7, d: 1.2},
      {x1: 300, y1: 250, x2: 700, y2: 400, t: 0.2, d: 1.9},
    ]
    let seg = svg.selectAll('.flowline').data(trace);
    let segEnter = seg.enter().append('path').attr('class', 'flowline').attr('stroke-opacity', 0)
      .attr('d', (t)=>`M${t.x1}, ${t.y1}, ${t.x2}, ${t.y2}`)
      .merge(seg);
    
    let trail = svg.selectAll('.traceline').data(trace);
    let trailEnter = trail.enter().append('path').attr('class', 'traceline').attr('stroke-opacity', 0)
      .attr('d', (t)=>`M${t.x1}, ${t.y1}, ${t.x2}, ${t.y2}`)
      .merge(trail);
    
    function animateSeg(){
      var seg = d3.select(this);
      const length = seg.node().getTotalLength(d3.easeLinear);
      var segData = seg.data();
      seg.attr("stroke-dashoffset", length*0.4).transition()
      .attr('stroke-opacity',10000)
      .duration(segData[0].t*3000)
      .delay(segData[0].d*3000)
      .attr('stroke-dasharray', length*0.4+" "+length)
      .attr("stroke-dashoffset", -length)
    }
    function animateTrail(){
      var trail = d3.select(this);
      const length = trail.node().getTotalLength();
      var trailData = trail.data();
      trail.attr("stroke-dashoffset", length).transition(d3.easePolyOut.exponent(0.1))
      .attr('stroke-opacity',0.5)
      .duration(trailData[0].t*3000)
      .delay(trailData[0].d*3000)
      .attr('stroke-dasharray', length+" "+length)
      .attr("stroke-dashoffset", 0)
    }
    //d3.selectAll('.traceline').each(animateTrail);
    d3.selectAll('.flowline').each(animateSeg);
    d3.selectAll('.traceline').each(animateTrail);
  </script>
</body>

</html>